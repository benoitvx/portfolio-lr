---
import Parser from 'rss-parser';
import SectionTitle from './SectionTitle.astro';

interface FeedItem {
  title: string;
  link: string;
  pubDate: string;
  contentSnippet?: string;
}

const RSS_URL = 'https://laetitiaroux.substack.com/feed';
const parser = new Parser();

let articles: FeedItem[] = [];
let error = false;

try {
  const feed = await parser.parseURL(RSS_URL);
  articles = (feed.items || []).slice(0, 3).map((item) => ({
    title: item.title || 'Sans titre',
    link: item.link || '#',
    pubDate: item.pubDate || '',
    contentSnippet: item.contentSnippet?.slice(0, 150) || '',
  }));
} catch (e) {
  console.error('Erreur lors du fetch RSS Substack:', e);
  error = true;
}

const formatDate = (dateString: string) => {
  if (!dateString) return '';
  try {
    return new Intl.DateTimeFormat('fr-FR', {
      day: 'numeric',
      month: 'long',
      year: 'numeric',
    }).format(new Date(dateString));
  } catch {
    return '';
  }
};
---

<section class="py-16 md:py-24 px-4">
  <div class="max-w-6xl mx-auto">
    <SectionTitle
      title="Newsletter"
      subtitle="Derniers articles sur Substack"
      href="https://laetitiaroux.substack.com/"
      linkText="S'abonner"
    />

    {error ? (
      <p class="text-center text-[--color-text-light]">
        Impossible de charger les articles pour le moment.
      </p>
    ) : articles.length === 0 ? (
      <p class="text-center text-[--color-text-light]">
        Aucun article disponible.
      </p>
    ) : (
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        {articles.map((article) => (
          <article class="group">
            <a
              href={article.link}
              target="_blank"
              rel="noopener noreferrer"
              class="block p-6 bg-[--color-bg-alt] rounded-sm hover:shadow-md transition-shadow"
            >
              <time
                datetime={article.pubDate}
                class="text-sm text-[--color-text-light]"
              >
                {formatDate(article.pubDate)}
              </time>
              <h3 class="font-serif text-xl text-[--color-text] mt-2 mb-3 group-hover:text-[--color-primary] transition-colors line-clamp-2">
                {article.title}
              </h3>
              {article.contentSnippet && (
                <p class="text-[--color-text-light] text-sm line-clamp-3">
                  {article.contentSnippet}...
                </p>
              )}
              <span class="inline-flex items-center gap-1 mt-4 text-sm text-[--color-primary] group-hover:text-[--color-primary-dark] transition-colors">
                Lire sur Substack
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </span>
            </a>
          </article>
        ))}
      </div>
    )}
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
